{% extends "base.html" %}

{% block title %}{{ platform|capitalize }} Credentials{% endblock %}

{% block content %}
<h1 style="text-transform: capitalize;">
    {% if platform == 'netflix' %}üé¨{% elif platform == 'crunchyroll' %}üçú{% elif platform == 'spotify' %}üéµ{% elif platform == 'wwe' %}ü§º{% endif %}
    {{ platform }} Credentials
</h1>

<div style="margin: 30px 0; display: flex; gap: 20px; flex-wrap: wrap;">
    <button onclick="showAddModal()" class="btn btn-success">‚ûï Add Credential</button>
    <button onclick="showUploadModal()" class="btn btn-primary">üì§ Upload from File</button>
</div>

<table>
    <thead>
        <tr>
            <th>#</th>
            <th>Email</th>
            <th>Password</th>
            <th>Status</th>
            <th>Created At</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for cred in credentials %}
        <tr id="row-{{ loop.index0 }}">
            <td>{{ loop.index }}</td>
            <td>{{ cred.email }}</td>
            <td>{{ cred.password }}</td>
            <td>
                <span class="badge badge-{{ cred.status }}">{{ cred.status }}</span>
            </td>
            <td>{{ cred.created_at[:19] if cred.created_at else 'N/A' }}</td>
            <td>
                <button onclick="editCredential({{ loop.index0 }}, '{{ cred.email }}', '{{ cred.password }}', '{{ cred.status }}')" class="btn btn-warning">‚úèÔ∏è Edit</button>
                <button onclick="deleteCredential({{ loop.index0 }})" class="btn btn-danger">üóëÔ∏è Delete</button>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="6" style="text-align: center; color: #999;">No credentials found. Add some to get started!</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div id="addModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeAddModal()">&times;</span>
        <h2>Add New Credential</h2>
        <form id="addForm">
            <div class="form-group">
                <label>Email</label>
                <input type="email" name="email" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="text" name="password" required>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select name="status">
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
            <button type="submit" class="btn btn-success">Add Credential</button>
        </form>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeEditModal()">&times;</span>
        <h2>Edit Credential</h2>
        <form id="editForm">
            <input type="hidden" id="editIndex" name="index">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="editEmail" name="email" required>
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="text" id="editPassword" name="password" required>
            </div>
            <div class="form-group">
                <label>Status</label>
                <select id="editStatus" name="status">
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                    <option value="claimed">Claimed</option>
                </select>
            </div>
            <button type="submit" class="btn btn-warning">Update Credential</button>
        </form>
    </div>
</div>

<div id="uploadModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeUploadModal()">&times;</span>
        <h2>Upload Credentials from File</h2>
        <p style="color: #666; margin-bottom: 20px;">Upload a .txt file with credentials in format:<br>
        <code style="background: #f5f5f5; padding: 10px; display: block; margin-top: 10px; border-radius: 5px;">
            email@email.com:password123:active<br>
            email123@email.com:password1234:active
        </code>
        </p>
        <form action="/credentials/{{ platform }}/upload" method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label>Select File</label>
                <input type="file" name="file" accept=".txt" required>
            </div>
            <button type="submit" class="btn btn-primary">Upload</button>
        </form>
    </div>
</div>

<script>
    const platform = '{{ platform }}';

    function showAddModal() {
        document.getElementById('addModal').classList.add('active');
    }

    function closeAddModal() {
        document.getElementById('addModal').classList.remove('active');
        document.getElementById('addForm').reset();
    }

    function showUploadModal() {
        document.getElementById('uploadModal').classList.add('active');
    }

    function closeUploadModal() {
        document.getElementById('uploadModal').classList.remove('active');
    }

    function showEditModal() {
        document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.remove('active');
        document.getElementById('editForm').reset();
    }

    document.getElementById('addForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        try {
            const response = await fetch(`/credentials/${platform}/add`, {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            
            if (result.success) {
                alert(result.message);
                location.reload();
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            alert('Error adding credential: ' + error.message);
        }
    });

    function editCredential(index, email, password, status) {
        document.getElementById('editIndex').value = index;
        document.getElementById('editEmail').value = email;
        document.getElementById('editPassword').value = password;
        document.getElementById('editStatus').value = status;
        showEditModal();
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const index = document.getElementById('editIndex').value;
        const formData = new FormData(e.target);
        
        try {
            const response = await fetch(`/credentials/${platform}/edit/${index}`, {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            
            if (result.success) {
                alert(result.message);
                location.reload();
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            alert('Error updating credential: ' + error.message);
        }
    });

    async function deleteCredential(index) {
        if (!confirm('Are you sure you want to delete this credential?')) {
            return;
        }
        
        try {
            const response = await fetch(`/credentials/${platform}/delete/${index}`, {
                method: 'POST'
            });
            const result = await response.json();
            
            if (result.success) {
                alert(result.message);
                location.reload();
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            alert('Error deleting credential: ' + error.message);
        }
    }
</script>
{% endblock %}
